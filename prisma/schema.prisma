generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String    @unique
  phone          String?
  emailVerified  DateTime?
  hashedPassword String?
  image          String?
  role           Role      @default(OWNER)
  consentGivenAt DateTime?
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  workspaceId    String?
  workspace      Workspace? @relation(fields: [workspaceId], references: [id])
  accounts       Account[]
  sessions       Session[]
  notificationPreferences NotificationPreference[]
  invitationsSent Invitation[]
  employee       Employee?
  pushSubscriptions PushSubscription[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  expires   DateTime
  createdAt DateTime @default(now())
  @@index([email])
}

enum Role {
  OWNER
  ADMIN
  MANAGER
  EMPLOYEE
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

model Invitation {
  id          String           @id @default(cuid())
  token       String           @unique
  email       String
  role        Role             @default(EMPLOYEE)
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  workspaceId String
  workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedById String
  invitedBy   User             @relation(fields: [invitedById], references: [id], onDelete: Cascade)
  @@index([workspaceId])
  @@index([email, workspaceId])
}

model Workspace {
  id         String   @id @default(cuid())
  name       String
  slug       String   @unique
  industry   String?
  bundesland String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  members    User[]
  employees  Employee[]
  shifts     Shift[]
  locations  Location[]
  departments Department[]
  timeEntries TimeEntry[]
  absenceRequests AbsenceRequest[]
  availabilities  Availability[]
  shiftSwaps      ShiftSwapRequest[]
  shiftChangeRequests ShiftChangeRequest[]
  timeAccounts    TimeAccount[]
  automationSettings AutomationSetting[]
  invitations Invitation[]
  vacationBalances VacationBalance[]
  skills      Skill[]
  shiftTemplates ShiftTemplate[]
  clients     Client[]
  projects    Project[]
  monthCloses MonthClose[]
  exportJobs  ExportJob[]
  webhookEndpoints WebhookEndpoint[]
  automationRules AutomationRule[]
}

model Employee {
  id           String   @id @default(cuid())
  firstName    String
  lastName     String
  email        String?
  phone        String?
  position     String?
  hourlyRate   Float?
  weeklyHours  Float?
  color        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  workspaceId  String
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId       String?  @unique
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  shifts       Shift[]
  timeEntries  TimeEntry[]
  absenceRequests AbsenceRequest[]
  availabilities  Availability[]
  swapsRequested  ShiftSwapRequest[] @relation("SwapRequester")
  swapsOffered    ShiftSwapRequest[] @relation("SwapTarget")
  changeRequests  ShiftChangeRequest[]
  timeAccount     TimeAccount?
  vacationBalances VacationBalance[]
  employeeSkills  EmployeeSkill[]
  projectMembers  ProjectMember[]
  @@unique([email, workspaceId])
}

model Location {
  id        String   @id @default(cuid())
  name      String
  address   String?
  createdAt DateTime @default(now())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  shifts      Shift[]
  timeEntries TimeEntry[]
  departments Department[]
  shiftTemplates ShiftTemplate[]
}

model Department {
  id        String   @id @default(cuid())
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  locationId  String?
  location    Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  employees   Employee[]
  @@index([workspaceId])
}

model Skill {
  id        String   @id @default(cuid())
  name      String
  category  String?
  createdAt DateTime @default(now())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  employeeSkills EmployeeSkill[]
  @@unique([name, workspaceId])
  @@index([workspaceId])
}

model EmployeeSkill {
  id         String    @id @default(cuid())
  expiresAt  DateTime? @db.Date
  createdAt  DateTime  @default(now())
  employeeId String
  employee   Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  skillId    String
  skill      Skill     @relation(fields: [skillId], references: [id], onDelete: Cascade)
  @@unique([employeeId, skillId])
}

model ShiftTemplate {
  id        String   @id @default(cuid())
  name      String
  startTime String
  endTime   String
  color     String?
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId])
}

model Shift {
  id        String      @id @default(cuid())
  date      DateTime    @db.Date
  startTime String
  endTime   String
  notes     String?
  status    ShiftStatus @default(SCHEDULED)
  isNightShift   Boolean @default(false)
  isHolidayShift Boolean @default(false)
  isSundayShift  Boolean @default(false)
  surchargePercent Float @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  employeeId  String?
  employee    Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  locationId  String?
  location    Location? @relation(fields: [locationId], references: [id])
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  swapsFrom   ShiftSwapRequest[] @relation("SwapFromShift")
  swapsTo     ShiftSwapRequest[] @relation("SwapToShift")
  changeRequests ShiftChangeRequest[]
  @@index([workspaceId, date])
  @@index([employeeId, date])
}

enum ShiftStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  OPEN
}

model PublicHoliday {
  id         String   @id @default(cuid())
  name       String
  date       DateTime @db.Date
  bundesland String
  isNational Boolean  @default(false)
  createdAt  DateTime @default(now())
  @@unique([date, bundesland])
  @@index([date])
  @@index([bundesland])
}

model VacationBalance {
  id               String   @id @default(cuid())
  year             Int
  totalEntitlement Float    @default(20)
  carryOver        Float    @default(0)
  used             Float    @default(0)
  planned          Float    @default(0)
  remaining        Float    @default(20)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  employeeId       String
  employee         Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  workspaceId      String
  workspace        Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@unique([employeeId, year])
  @@index([workspaceId])
}

enum TimeEntryStatus {
  ENTWURF
  EINGEREICHT
  KORREKTUR
  ZURUECKGEWIESEN
  GEPRUEFT
  BESTAETIGT
}

model TimeEntry {
  id           String          @id @default(cuid())
  date         DateTime        @db.Date
  startTime    String
  endTime      String
  breakStart   String?
  breakEnd     String?
  breakMinutes Int             @default(0)
  grossMinutes Int             @default(0)
  netMinutes   Int             @default(0)
  remarks      String?
  status       TimeEntryStatus @default(ENTWURF)
  submittedAt  DateTime?
  confirmedAt  DateTime?
  confirmedBy  String?
  clockInLat   Float?
  clockInLng   Float?
  clockOutLat  Float?
  clockOutLng  Float?
  clockInAt    DateTime?
  clockOutAt   DateTime?
  isLiveClock  Boolean         @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  employeeId   String
  employee     Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  locationId   String?
  location     Location?       @relation(fields: [locationId], references: [id])
  shiftId      String?
  projectId    String?
  project      Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  workspaceId  String
  workspace    Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  auditLog     TimeEntryAudit[]
  @@index([workspaceId, date])
  @@index([employeeId, date])
  @@index([status])
  @@index([projectId])
}

model TimeEntryAudit {
  id          String   @id @default(cuid())
  action      String
  changes     String?  @db.Text
  comment     String?
  performedBy String
  performedAt DateTime @default(now())
  timeEntryId String
  timeEntry   TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  @@index([timeEntryId])
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String   @db.Text
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
  userId      String
  workspaceId String
  @@index([userId, read])
  @@index([workspaceId])
}

enum AbsenceRequestStatus {
  AUSSTEHEND
  GENEHMIGT
  ABGELEHNT
  STORNIERT
}

enum AbsenceCategory {
  URLAUB
  KRANK
  ELTERNZEIT
  SONDERURLAUB
  UNBEZAHLT
  FORTBILDUNG
  SONSTIGES
}

model AbsenceRequest {
  id          String              @id @default(cuid())
  category    AbsenceCategory
  startDate   DateTime            @db.Date
  endDate     DateTime            @db.Date
  halfDayStart Boolean            @default(false)
  halfDayEnd   Boolean            @default(false)
  totalDays   Float               @default(0)
  reason      String?             @db.Text
  status      AbsenceRequestStatus @default(AUSSTEHEND)
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNote  String?             @db.Text
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  employeeId  String
  employee    Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  workspaceId String
  workspace   Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId, status])
  @@index([employeeId, startDate])
}

enum AvailabilityType {
  VERFUEGBAR
  BEVORZUGT
  NICHT_VERFUEGBAR
}

model Availability {
  id          String           @id @default(cuid())
  weekday     Int
  startTime   String?
  endTime     String?
  type        AvailabilityType @default(VERFUEGBAR)
  validFrom   DateTime         @db.Date
  validUntil  DateTime?        @db.Date
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  employeeId  String
  employee    Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  workspaceId String
  workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId, employeeId])
  @@index([employeeId, weekday])
}

enum ChangeRequestStatus {
  AUSSTEHEND
  GENEHMIGT
  ABGELEHNT
  STORNIERT
}

model ShiftChangeRequest {
  id            String              @id @default(cuid())
  status        ChangeRequestStatus @default(AUSSTEHEND)
  reason        String?             @db.Text
  shiftId       String
  shift         Shift               @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  newDate       DateTime?           @db.Date
  newStartTime  String?
  newEndTime    String?
  newNotes      String?             @db.Text
  requesterId   String
  requester     Employee            @relation(fields: [requesterId], references: [id], onDelete: Cascade)
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNote    String?             @db.Text
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  workspaceId   String
  workspace     Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId, status])
  @@index([requesterId])
  @@index([shiftId])
}

enum SwapStatus {
  ANGEFRAGT
  ANGENOMMEN
  GENEHMIGT
  ABGELEHNT
  STORNIERT
  ABGESCHLOSSEN
}

model ShiftSwapRequest {
  id            String     @id @default(cuid())
  status        SwapStatus @default(ANGEFRAGT)
  reason        String?    @db.Text
  shiftId       String
  shift         Shift      @relation("SwapFromShift", fields: [shiftId], references: [id])
  targetShiftId String?
  targetShift   Shift?     @relation("SwapToShift", fields: [targetShiftId], references: [id])
  requesterId   String
  requester     Employee   @relation("SwapRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  targetId      String?
  target        Employee?  @relation("SwapTarget", fields: [targetId], references: [id])
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNote    String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  workspaceId   String
  workspace     Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId, status])
  @@index([requesterId])
  @@index([targetId])
}

model TimeAccount {
  id              String   @id @default(cuid())
  contractHours   Float    @default(40)
  carryoverMinutes Int     @default(0)
  currentBalance  Int      @default(0)
  lastCalculated  DateTime @default(now())
  periodStart     DateTime @db.Date
  periodEnd       DateTime? @db.Date
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  employeeId      String   @unique
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  workspaceId     String
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId])
}

enum NotificationChannel {
  EMAIL
  PUSH
}

model NotificationPreference {
  id        String              @id @default(cuid())
  channel   NotificationChannel
  enabled   Boolean             @default(false)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, channel])
  @@index([userId])
}

model AutomationSetting {
  id        String   @id @default(cuid())
  key       String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@unique([workspaceId, key])
  @@index([workspaceId])
}

// ═══════════════════════════════════════════════════════════════
// PUSH NOTIFICATIONS
// ═══════════════════════════════════════════════════════════════

model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @db.Text
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, endpoint])
  @@index([userId])
}

// ═══════════════════════════════════════════════════════════════
// PROJECT MODULE
// ═══════════════════════════════════════════════════════════════

model Client {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?  @db.Text
  notes     String?  @db.Text
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  projects    Project[]
  @@index([workspaceId])
}

enum ProjectStatus {
  AKTIV
  PAUSIERT
  ABGESCHLOSSEN
  ARCHIVIERT
}

model Project {
  id           String        @id @default(cuid())
  name         String
  description  String?       @db.Text
  status       ProjectStatus @default(AKTIV)
  costRate     Float?
  billRate     Float?
  budgetMinutes Int?
  startDate    DateTime?     @db.Date
  endDate      DateTime?     @db.Date
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  clientId     String?
  client       Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  workspaceId  String
  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members      ProjectMember[]
  timeEntries  TimeEntry[]
  @@index([workspaceId])
  @@index([clientId])
}

model ProjectMember {
  id         String   @id @default(cuid())
  role       String   @default("MEMBER")
  createdAt  DateTime @default(now())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  @@unique([employeeId, projectId])
}

// ═══════════════════════════════════════════════════════════════
// MONTH CLOSE WORKFLOW
// ═══════════════════════════════════════════════════════════════

enum MonthCloseStatus {
  OPEN
  LOCKED
  EXPORTED
}

model MonthClose {
  id          String          @id @default(cuid())
  year        Int
  month       Int
  status      MonthCloseStatus @default(OPEN)
  lockedBy    String?
  lockedAt    DateTime?
  exportedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  workspaceId String
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  exportJobs  ExportJob[]
  @@unique([workspaceId, year, month])
  @@index([workspaceId])
}

model ExportJob {
  id           String   @id @default(cuid())
  format       String
  fileName     String
  fileUrl      String?  @db.Text
  status       String   @default("PENDING")
  errorMessage String?  @db.Text
  createdAt    DateTime @default(now())
  completedAt  DateTime?
  monthCloseId String?
  monthClose   MonthClose? @relation(fields: [monthCloseId], references: [id], onDelete: SetNull)
  projectId    String?
  workspaceId  String
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId])
}

// ═══════════════════════════════════════════════════════════════
// WEBHOOKS
// ═══════════════════════════════════════════════════════════════

model WebhookEndpoint {
  id        String   @id @default(cuid())
  url       String   @db.Text
  secret    String
  events    String[]
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId])
}

// ═══════════════════════════════════════════════════════════════
// CUSTOM AUTOMATION RULES
// ═══════════════════════════════════════════════════════════════

model AutomationRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  trigger     String
  conditions  String   @db.Text
  actions     String   @db.Text
  isActive    Boolean  @default(true)
  lastTriggered DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  @@index([workspaceId])
}
